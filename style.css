document.addEventListener('DOMContentLoaded', () => {
  // Alternância de abas
  const abas = document.querySelectorAll('.aba');
  const menuButtons = document.querySelectorAll('.menu-superior button');
  const abaIds = Array.from(menuButtons).map(btn => btn.dataset.aba);

  function mostrarAba(idAba) {
    abas.forEach(aba => {
      aba.style.display = (aba.id === 'aba-' + idAba) ? 'block' : 'none';
    });
    menuButtons.forEach(btn => {
      if (btn.dataset.aba === idAba) {
        btn.classList.add('active');
        btn.setAttribute('aria-current', 'page');
      } else {
        btn.classList.remove('active');
        btn.removeAttribute('aria-current');
      }
    });
    localStorage.setItem('abaAtiva', idAba);
    onAbaChange(idAba);
  }

  menuButtons.forEach(btn => {
    btn.addEventListener('click', () => mostrarAba(btn.dataset.aba));
    btn.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        mostrarAba(btn.dataset.aba);
      }
    });
    btn.setAttribute('tabindex', '0');
  });

  // Tema claro/escuro
  const btnAlternarTema = document.getElementById('btnAlternarTema');
  function aplicarTemaSalvo() {
    if (localStorage.getItem('tema') === 'claro') {
      document.body.classList.add('claro');
    } else {
      document.body.classList.remove('claro');
    }
  }
  if (btnAlternarTema) {
    btnAlternarTema.addEventListener('click', () => {
      document.body.classList.toggle('claro');
      localStorage.setItem('tema', document.body.classList.contains('claro') ? 'claro' : 'escuro');
      mostrarToast('Tema alterado!', 'info');
    });
    aplicarTemaSalvo();
  } else {
    aplicarTemaSalvo();
  }

  // Toast simples
  function criarToastContainer() {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.position = 'fixed';
      toastContainer.style.bottom = '20px';
      toastContainer.style.right = '20px';
      toastContainer.style.zIndex = '9999';
      toastContainer.style.maxWidth = '90vw';
      document.body.appendChild(toastContainer);
    }
    return toastContainer;
  }
  window.mostrarToast = function(msg, tipo = 'info', tempo = 2500) {
    const toastContainer = criarToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast toast-${tipo}`;
    toast.textContent = msg;
    toastContainer.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '1'; }, 50);
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, tempo);
  };

  // Botão flutuante de cada aba
  const abasCadastro = [
    { aba: 'aplicacoes', btn: 'btnAdicionarAplicacao', form: 'formAplicacao' },
    { aba: 'tarefas', btn: 'btnAdicionarTarefa', form: 'formTarefa' },
    { aba: 'financeiro', btn: 'btnAdicionarFinanceiro', form: 'formFinanceiro' },
    { aba: 'colheita', btn: 'btnAdicionarColheita', form: 'formColheita' }
  ];

  function mostrarBotaoFlutuante(abaAtiva) {
    abasCadastro.forEach(({aba, btn, form}) => {
      const botao = document.getElementById(btn);
      const formulario = document.getElementById(form);
      if (botao) botao.style.display = (abaAtiva === aba && formulario.classList.contains('hidden')) ? 'flex' : 'none';
    });
  }
  function onAbaChange(idAba) {
    mostrarBotaoFlutuante(idAba);
  }
  abasCadastro.forEach(({btn, form}) => {
    const botao = document.getElementById(btn);
    const formulario = document.getElementById(form);
    if (botao && formulario) {
      botao.addEventListener('click', () => {
        formulario.classList.remove('hidden');
        botao.style.display = 'none';
        const input = formulario.querySelector('input, select, textarea');
        if (input) input.focus();
      });
    }
  });
  abasCadastro.forEach(({btn, form}) => {
    const botao = document.getElementById(btn);
    const formulario = document.getElementById(form);
    if (formulario) {
      formulario.addEventListener('submit', function(e) {
        setTimeout(() => {
          formulario.classList.add('hidden');
          if (botao) botao.style.display = 'flex';
        }, 100);
      });
      const btnCancelar = formulario.querySelector('button[type="button"].btn-secondary, .btn-cancelar');
      if (btnCancelar) {
        btnCancelar.addEventListener('click', () => {
          formulario.classList.add('hidden');
          if (botao) botao.style.display = 'flex';
        });
