<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manejo Café</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #333;
    }

    .conteudo {
      padding: 20px;
      padding-bottom: 80px;
      max-width: 800px;
      margin: auto;
    }

    .aba {
      display: none;
    }

    .aba.active {
      display: block;
      animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      background-color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #43a047;
    }

    .menu-superior {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-top: 1px solid #ddd;
      z-index: 999;
    }

    .menu-superior button {
      background: none;
      border: none;
      font-size: 22px;
      color: #aaa;
      transition: 0.3s;
    }

    .menu-superior button.active,
    .menu-superior button:hover {
      color: #4CAF50;
    }

    .grupo-data {
      margin-top: 20px;
      font-weight: bold;
      color: #4CAF50;
    }

    .item {
      background-color: #fff;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item span {
      flex-grow: 1;
      word-break: break-word;
    }

    .botao-excluir {
      background-color: #e53935;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .botao-excluir:hover {
      background-color: #d32f2f;
    }

    .campo-pesquisa {
      border: 1px solid #ccc;
      background-color: #fff;
    }
  </style>
</head>
<body>

<div class="menu-superior">
  <button id="btn-aplicacoes" onclick="mostrarAba('aplicacoes')"><i class="fas fa-flask"></i></button>
  <button id="btn-tarefas" onclick="mostrarAba('tarefas')"><i class="fas fa-check-square"></i></button>
  <button id="btn-financeiro" onclick="mostrarAba('financeiro')"><i class="fas fa-dollar-sign"></i></button>
  <button id="btn-colheita" onclick="mostrarAba('colheita')"><i class="fas fa-tractor"></i></button>
  <button id="btn-relatorio" onclick="mostrarAba('relatorio')"><i class="fas fa-chart-line"></i></button>
  <button id="btn-configuracoes" onclick="mostrarAba('configuracoes')"><i class="fas fa-cog"></i></button>
</div>

<div class="conteudo">

  <!-- INÍCIO ABA APLICAÇÕES -->
<div id="aplicacoes" class="aba active">
  <h2>Aplicações</h2>

  <label>Data</label>
  <input id="dataApp" type="date">

  <label>Produto</label>
  <input id="produtoApp" placeholder="Nome do Produto">

  <label>Dosagem</label>
  <input id="dosagemApp" placeholder="Ex: 100g / bomba">

  <label>Tipo</label>
  <select id="tipoApp">
    <option>Adubo</option>
    <option>Fungicida</option>
    <option>Inseticida</option>
    <option>Herbicida</option>
  </select>

  <label>Setor</label>
  <select id="setorApp">
    <option>Setor 01</option>
    <option>Setor 02</option>
  </select>

  <button onclick="adicionarAplicacao()"><i class="fas fa-save"></i> Salvar Aplicação</button>

  <hr style="margin: 25px 0;">

  <h3>Histórico</h3>

  <label>Filtrar por Setor</label>
  <select id="filtroSetorAplicacoes" onchange="atualizarAplicacoes()">
    <option value="">Todos os Setores</option>
    <option value="Setor 01">Setor 01</option>
    <option value="Setor 02">Setor 02</option>
  </select>

  <input id="pesquisaAplicacoes" class="campo-pesquisa" placeholder="Pesquisar produto..." oninput="atualizarAplicacoes()">

  <div id="listaAplicacoes"></div>
</div>
<!-- FIM ABA APLICAÇÕES -->

  <!-- INÍCIO ABA TAREFAS -->
<div id="tarefas" class="aba">
  <h2>Tarefas</h2>

  <label>Data</label>
  <input id="dataTarefa" type="date">

  <label>Descrição</label>
  <input id="descricaoTarefa" placeholder="Ex: Aplicar fertilizante, capina...">

  <label>Prioridade</label>
  <select id="prioridadeTarefa">
    <option>Alta</option>
    <option>Média</option>
    <option>Baixa</option>
  </select>

  <label>Setor</label>
  <select id="setorTarefa">
    <option>Setor 01</option>
    <option>Setor 02</option>
  </select>

  <label class="checkbox-label">
    <input type="checkbox" id="eAplicacaoCheckbox" onchange="mostrarCamposAplicacao()"> É Aplicação?
  </label>

  <div id="camposAplicacao" style="display:none;">
    <label>Dosagem</label>
    <input id="dosagemAplicacao" placeholder="Ex: 200 ml / bomba">

    <label>Tipo de Aplicação</label>
    <select id="tipoAplicacao">
      <option>Adubo</option>
      <option>Fungicida</option>
      <option>Inseticida</option>
      <option>Herbicida</option>
    </select>
  </div>

  <button onclick="adicionarTarefa()"><i class="fas fa-check-circle"></i> Salvar Tarefa</button>

  <hr style="margin: 25px 0;">

  <h3>Filtro de Tarefas</h3>
  <label>Setor</label>
  <select id="filtroSetorTarefas" onchange="atualizarTarefas()">
    <option value="">Todos os Setores</option>
    <option value="Setor 01">Setor 01</option>
    <option value="Setor 02">Setor 02</option>
  </select>

  <input id="pesquisaTarefas" class="campo-pesquisa" placeholder="Pesquisar..." oninput="atualizarTarefas()">

  <h4 style="color:#ffca28; margin-top: 20px;">Tarefas a Fazer</h4>
  <div id="listaTarefas"></div>

  <h4 style="color:#4caf50; margin-top: 30px;">Tarefas Executadas</h4>
  <div id="listaTarefasFeitas"></div>
</div>
<!-- FIM ABA TAREFAS -->

  <!-- INÍCIO ABA FINANCEIRO -->
<div id="financeiro" class="aba">
  <h2>Financeiro</h2>

  <label>Data</label>
  <input id="dataFin" type="date">

  <label>Produto ou Serviço</label>
  <input id="produtoFin" placeholder="Ex: Fertilizante, Mão de Obra...">

  <label>Valor (R$)</label>
  <input id="valorFin" type="number" placeholder="Digite o valor">

  <label>Categoria</label>
  <select id="tipoFin">
    <option>Adubo</option>
    <option>Fungicida</option>
    <option>Inseticida</option>
    <option>Herbicida</option>
  </select>

  <button onclick="adicionarFinanceiro()"><i class="fas fa-save"></i> Salvar Gasto</button>

  <hr style="margin: 25px 0;">

  <h3>Filtro de Gastos</h3>
  <input id="pesquisaFinanceiro" class="campo-pesquisa" placeholder="Pesquisar por nome ou tipo..." oninput="atualizarFinanceiro()">

  <h4 style="color: #ffca28; margin-top: 20px;">A Vencer</h4>
  <div id="financeiroVencer"></div>

  <h4 style="color: #4caf50; margin-top: 30px;">Pagos</h4>
  <div id="financeiroPago"></div>

  <h4 style="margin-top: 30px;">Gráfico de Gastos</h4>
  <canvas id="graficoGastos"></canvas>
</div>
<!-- FIM ABA FINANCEIRO -->

  <!-- INÍCIO ABA COLHEITA -->
<div id="colheita" class="aba">
  <h2>Colheita</h2>

  <label>Valor da Lata (R$)</label>
  <input id="valorLata" type="number" placeholder="Digite o valor atual" onchange="salvarValorLata()" />

  <h3 style="margin-top: 30px;">Registrar Nova Colheita</h3>
  <label>Data</label>
  <input id="dataColheita" type="date" />
  <label>Nome do Colhedor</label>
  <input id="colhedor" placeholder="Ex: João, Maria..." />
  <label>Quantidade de Latas</label>
  <input id="quantidadeLatas" type="number" step="0.01" placeholder="Digite a quantidade" />
  <button onclick="adicionarColheita()"><i class="fas fa-plus-circle"></i> Adicionar Colheita</button>

  <hr style="margin: 30px 0;">

  <h3>Filtrar Colheitas</h3>
  <label>Data Início</label>
  <input id="filtroDataInicio" type="date" onchange="atualizarColheita()" />
  <label>Data Fim</label>
  <input id="filtroDataFim" type="date" onchange="atualizarColheita()" />
  <label>Pesquisar por Colhedor</label>
  <input id="pesquisaColheita" class="campo-pesquisa" placeholder="Digite o nome..." oninput="atualizarColheita()" />

  <div id="resumoColheita" style="font-weight: bold; margin-top: 20px; color: #66bb6a;"></div>

  <h4 style="color: #ff9800;">Pendentes</h4>
  <div id="colheitaPendentes"></div>

  <h4 style="color: #4caf50;">Pagos</h4>
  <div id="colheitaPagos"></div>

  <h4 style="margin-top: 30px;">Gráfico - Latas por Dia</h4>
  <canvas id="graficoColheita"></canvas>

  <h4 style="margin-top: 30px;">Gráfico - Latas por Colhedor</h4>
  <canvas id="graficoColhedor"></canvas>

  <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
    <button onclick="exportarRelatorioColheita()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    <button onclick="exportarCSVColheita()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
  </div>

  <h4 style="margin-top: 30px;">Consultar Safras Anteriores</h4>
  <select id="safraConsulta" onchange="consultarSafraAnterior()">
    <option value="">Selecione o ano</option>
    <option value="2023">2023</option>
    <option value="2024">2024</option>
    <option value="2025">2025</option>
  </select>
  <div id="resultadoSafraAnterior" style="margin-top: 10px;"></div>
</div>
<!-- FIM ABA COLHEITA -->

  <!-- INÍCIO ABA RELATÓRIO -->
<div id="relatorio" class="aba">
  <h2>Relatório</h2>

  <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
    <button onclick="mostrarRelatorio('aplicacoesRel')"><i class="fas fa-flask"></i> Aplicações</button>
    <button onclick="mostrarRelatorio('tarefasRel')"><i class="fas fa-tasks"></i> Tarefas</button>
    <button onclick="mostrarRelatorio('financeiroRel')"><i class="fas fa-dollar-sign"></i> Financeiro</button>
  </div>

  <div id="aplicacoesRel" class="relatorio-subaba">
    <h3>Últimas Aplicações</h3>
    <div id="ultimasAplicacoes"></div>
    <canvas id="graficoAplicacoes" style="margin-top: 20px;"></canvas>
  </div>

  <div id="tarefasRel" class="relatorio-subaba" style="display:none;">
    <h3>Últimas Tarefas</h3>
    <div id="ultimasTarefas"></div>
    <canvas id="graficoTarefas" style="margin-top: 20px;"></canvas>
  </div>

  <div id="financeiroRel" class="relatorio-subaba" style="display:none;">
    <h3>Resumo Financeiro</h3>
    <div id="resumoFinanceiro"></div>
    <canvas id="graficoFinanceiro" style="margin-top: 20px;"></canvas>
  </div>

  <button onclick="exportarPDF()" style="margin-top: 20px;"><i class="fas fa-file-pdf"></i> Exportar PDF Completo</button>
</div>
<!-- FIM ABA RELATÓRIO -->

<!-- INÍCIO ABA CONFIGURAÇÕES -->
<div id="configuracoes" class="aba">
  <h2>Configurações</h2>

  <button onclick="alternarTema()"><i class="fas fa-adjust"></i> Alternar Tema Claro/Escuro</button>

  <hr style="margin: 30px 0;">
  <h3>Safra</h3>
  <p>Safra atual: <strong id="anoSafraAtual">---</strong></p>

  <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
    <button onclick="fecharSafraAtual()" style="background-color: #ff9800;">
      <i class="fas fa-archive"></i> Fechar Safra Atual
    </button>

    <select id="safraSelecionada">
      <option value="">Carregando safras...</option>
    </select>

    <button onclick="restaurarSafra()" style="background-color: #2196f3;">
      <i class="fas fa-undo-alt"></i> Restaurar Safra</button>

    <button onclick="deletarSafra()" style="background-color: #f44336;">
      <i class="fas fa-trash-alt"></i> Deletar Safra</button>
  </div>
</div>
<!-- FIM CONFIGURAÇÕES -->

<!-- MODAL DE PAGAMENTO PARCIAL -->
<div id="modalParcial" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000a; z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#2c2c2c; padding:20px; border-radius:10px; width:90%; max-width:300px; text-align:center;">
    <h3 style="color:#66bb6a;">Pagamento Parcial</h3>
    <p id="modalParcialTexto" style="margin-bottom:10px;"></p>
    <input type="number" id="inputParcial" placeholder="Valor a pagar (R$)" style="width:100%; padding:10px; border-radius:8px; border:1px solid #555; background:#1e1e1e; color:white;">
    <div style="margin-top:15px; display:flex; justify-content:space-between;">
      <button onclick="confirmarParcial()" style="flex:1; margin-right:5px;">Confirmar</button>
      <button onclick="fecharModalParcial()" style="flex:1; background:#f44336;">Cancelar</button>
    </div>
  </div>
</div>
<!-- FIM MODAL -->

  <!-- PARTE 5: Scripts Relatório, Configurações, Tema e Inicialização -->
<script>
  function mostrarRelatorio(id) {
    document.querySelectorAll('.relatorio-subaba').forEach(div => div.style.display = 'none');
    document.getElementById(id).style.display = 'block';
  }

  function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Resumo de Relatório", 20, 20);
    doc.save("relatorio.pdf");
  }

  function carregarAnoSafra() {
    const anoAtual = new Date().getFullYear();
    document.getElementById("anoSafraAtual").innerText = anoAtual;
  }

  function carregarSafrasDisponiveis() {
    db.ref('Safras').once('value', snap => {
      const select = document.getElementById('safraSelecionada');
      select.innerHTML = '<option value="">Selecione</option>';
      if (snap.exists()) {
        Object.keys(snap.val()).forEach(ano => {
          const opt = document.createElement('option');
          opt.value = ano;
          opt.textContent = ano;
          select.appendChild(opt);
        });
      }
    });
  }

  function fecharSafraAtual() {
    const ano = new Date().getFullYear().toString();
    db.ref(`Safras/${ano}`).set({
      aplicacoes,
      tarefas: [...tarefas, ...tarefasFeitas],
      financeiro: gastos,
      colheita
    }).then(() => alert("Safra fechada com sucesso!"));
  }

  function restaurarSafra() {
    const ano = document.getElementById("safraSelecionada").value;
    if (!ano) return;
    db.ref(`Safras/${ano}`).once('value').then(snap => {
      if (!snap.exists()) return alert("Dados não encontrados.");
      const dados = snap.val();
      aplicacoes.length = 0;
      tarefas.length = 0;
      tarefasFeitas.length = 0;
      gastos.length = 0;
      colheita.length = 0;

      aplicacoes.push(...(dados.aplicacoes || []));
      (dados.tarefas || []).forEach(t => (t.executada ? tarefasFeitas : tarefas).push(t));
      gastos.push(...(dados.financeiro || []));
      colheita.push(...(dados.colheita || []));

      db.ref('Aplicacoes').set(aplicacoes);
      db.ref('Tarefas').set([...tarefas, ...tarefasFeitas]);
      db.ref('Financeiro').set(gastos);
      db.ref('Colheita').set(colheita);
      atualizarAplicacoes();
      atualizarTarefas();
      atualizarFinanceiro();
      atualizarColheita();
      alert("Safra restaurada com sucesso!");
    });
  }

  function deletarSafra() {
    const ano = document.getElementById("safraSelecionada").value;
    if (!ano || !confirm("Deseja deletar a safra selecionada?")) return;
    db.ref(`Safras/${ano}`).remove().then(() => {
      alert("Safra deletada.");
      carregarSafrasDisponiveis();
    });
  }

  function alternarTema() {
    document.body.classList.toggle("claro");
    const temaAtual = document.body.classList.contains("claro") ? "claro" : "escuro";
    localStorage.setItem("tema", temaAtual);
  }
</script>
