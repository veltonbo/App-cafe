<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Manejo Café</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS (for layout, forms, buttons) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #343a40;
      color: #ffffff;
    }
    .navbar {
      background-color: #212529;
    }
    .nav-link {
      color: #ffffff;
    }
    .nav-link:hover {
      color: #cccccc;
    }
    .active-link {
      color: #28a745 !important; /* green for active item */
    }
    .section {
      display: none;
      padding: 20px;
    }
    .visible {
      display: block;
    }
    .btn-green {
      background-color: #28a745;
      color: #fff;
    }
    .btn-green:hover {
      background-color: #218838;
    }
    .btn-red {
      background-color: #dc3545;
      color: #fff;
    }
    .btn-red:hover {
      background-color: #c82333;
    }
    .light-theme {
      background-color: #f8f9fa;
      color: #212529;
    }
    .light-theme .navbar {
      background-color: #e9ecef;
    }
    .light-theme .nav-link {
      color: #212529;
    }
    .light-theme .nav-link:hover {
      color: #444;
    }
    .light-theme .active-link {
      color: #28a745 !important;
    }
    .light-theme input, .light-theme select {
      background-color: #fff;
      color: #212529;
    }
    .chart-container {
      width: 100%;
      max-width: 600px;
      margin: auto;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Manejo Café</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
        aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMenu">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active-link" href="#" id="menu-aplicacoes-link">
              <i class="fas fa-spray-can"></i> Aplicações
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="menu-tarefas-link">
              <i class="fas fa-tasks"></i> Tarefas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="menu-financeiro-link">
              <i class="fas fa-dollar-sign"></i> Financeiro
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="menu-colheita-link">
              <i class="fas fa-leaf"></i> Colheita
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="menu-relatorio-link">
              <i class="fas fa-chart-bar"></i> Relatório
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="menu-config-link">
              <i class="fas fa-cog"></i> Configurações
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main content sections -->
  <div class="container-fluid">
    <!-- Aplicações Section -->
    <section id="aplicacoes-section" class="section visible">
      <h2>Aplicações</h2>
      <form id="aplicacao-form" class="mb-3">
        <div class="row g-2">
          <div class="col-md-3">
            <input type="text" id="aplicacao-produto" class="form-control" placeholder="Produto">
          </div>
          <div class="col-md-2">
            <input type="text" id="aplicacao-setor" class="form-control" placeholder="Setor">
          </div>
          <div class="col-md-2">
            <input type="text" id="aplicacao-tipo" class="form-control" placeholder="Tipo">
          </div>
          <div class="col-md-2">
            <input type="text" id="aplicacao-dosagem" class="form-control" placeholder="Dosagem">
          </div>
          <div class="col-md-2">
            <input type="date" id="aplicacao-data" class="form-control">
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-green w-100" id="btn-add-aplicacao">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </form>
      <div id="lista-aplicacoes"></div>
    </section>

    <!-- Tarefas Section -->
    <section id="tarefas-section" class="section">
      <h2>Tarefas</h2>
      <form id="tarefa-form" class="mb-3">
        <div class="row g-2">
          <div class="col-md-6">
            <input type="text" id="tarefa-desc" class="form-control" placeholder="Descrição da tarefa">
          </div>
          <div class="col-md-3">
            <select id="tarefa-prioridade" class="form-control">
              <option value="Baixa">Baixa</option>
              <option value="Média">Média</option>
              <option value="Alta">Alta</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="tarefa-tipo" class="form-control">
              <option value="Geral">Geral</option>
              <option value="Aplicação">Aplicação</option>
            </select>
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-green w-100" id="btn-add-tarefa">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </form>
      <div id="lista-tarefas" class="list-group"></div>
    </section>

    <!-- Financeiro Section -->
    <section id="financeiro-section" class="section">
      <h2>Financeiro</h2>
      <form id="fin-form" class="mb-3">
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" id="fin-desc" class="form-control" placeholder="Descrição">
          </div>
          <div class="col-md-3">
            <input type="number" id="fin-valor" class="form-control" placeholder="Valor">
          </div>
          <div class="col-md-3">
            <select id="fin-status" class="form-control">
              <option value="avencer">A Vencer</option>
              <option value="pago">Pago</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-green w-100" id="btn-add-fin">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </form>
      <div class="row">
        <div class="col-md-6">
          <h5>A Vencer</h5>
          <ul id="fin-avencer" class="list-group mb-3"></ul>
        </div>
        <div class="col-md-6">
          <h5>Pagos</h5>
          <ul id="fin-pagos" class="list-group mb-3"></ul>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 chart-container">
          <canvas id="chart-financeiro-bar"></canvas>
        </div>
        <div class="col-md-6 chart-container">
          <canvas id="chart-financeiro-pie"></canvas>
        </div>
      </div>
    </section>

    <!-- Colheita Section -->
    <section id="colheita-section" class="section">
      <h2>Colheita</h2>
      <form id="colheita-form" class="mb-3">
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" id="colheita-colhedor" class="form-control" placeholder="Colhedor">
          </div>
          <div class="col-md-3">
            <input type="date" id="colheita-data" class="form-control">
          </div>
          <div class="col-md-3">
            <input type="number" id="colheita-latas" class="form-control" placeholder="Latas">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-green w-100" id="btn-add-colheita">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </form>
      <div id="lista-colheita"></div>
      <h5>Total geral: <span id="total-latas">0</span> latas</h5>
    </section>

    <!-- Relatório Section -->
    <section id="relatorio-section" class="section">
      <h2>Relatório</h2>
      <div class="row">
        <div class="col-md-6 chart-container">
          <canvas id="chart-relatorio-aplic"></canvas>
        </div>
        <div class="col-md-6 chart-container">
          <canvas id="chart-relatorio-tarefas"></canvas>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-md-6 chart-container">
          <canvas id="chart-relatorio-fin"></canvas>
        </div>
      </div>
      <button class="btn btn-green mt-3" id="btn-download-report">
        <i class="fas fa-file-pdf"></i> Baixar Relatório (PDF)
      </button>
    </section>

    <!-- Configurações Section -->
    <section id="config-section" class="section">
      <h2>Configurações</h2>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggle-theme">
        <label class="form-check-label" for="toggle-theme">Tema Claro</label>
      </div>
    </section>
  </div>

  <!-- Scripts -->
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Initialize Firebase
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // Navigation
    const sections = {
      aplicacoes: document.getElementById('aplicacoes-section'),
      tarefas: document.getElementById('tarefas-section'),
      financeiro: document.getElementById('financeiro-section'),
      colheita: document.getElementById('colheita-section'),
      relatorio: document.getElementById('relatorio-section'),
      config: document.getElementById('config-section')
    };
    const links = {
      aplicacoes: document.getElementById('menu-aplicacoes-link'),
      tarefas: document.getElementById('menu-tarefas-link'),
      financeiro: document.getElementById('menu-financeiro-link'),
      colheita: document.getElementById('menu-colheita-link'),
      relatorio: document.getElementById('menu-relatorio-link'),
      config: document.getElementById('menu-config-link')
    };
    function showSection(section) {
      for (let key in sections) {
        sections[key].classList.remove('visible');
        links[key].classList.remove('active-link');
      }
      sections[section].classList.add('visible');
      links[section].classList.add('active-link');
    }
    links.aplicacoes.addEventListener('click', (e) => { e.preventDefault(); showSection('aplicacoes'); });
    links.tarefas.addEventListener('click', (e) => { e.preventDefault(); showSection('tarefas'); });
    links.financeiro.addEventListener('click', (e) => { e.preventDefault(); showSection('financeiro'); });
    links.colheita.addEventListener('click', (e) => { e.preventDefault(); showSection('colheita'); });
    links.relatorio.addEventListener('click', (e) => { e.preventDefault(); showSection('relatorio'); });
    links.config.addEventListener('click', (e) => { e.preventDefault(); showSection('config'); });

    // Aplicações
    const aplicacoesRef = db.ref('aplicacoes');
    function addAplicacao() {
      const produto = document.getElementById('aplicacao-produto').value;
      const setor = document.getElementById('aplicacao-setor').value;
      const tipo = document.getElementById('aplicacao-tipo').value;
      const dosagem = document.getElementById('aplicacao-dosagem').value;
      const data = document.getElementById('aplicacao-data').value;
      if (produto && setor && tipo && dosagem && data) {
        const newApp = { produto, setor, tipo, dosagem, data };
        aplicacoesRef.push(newApp);
        document.getElementById('aplicacao-form').reset();
      }
    }
    document.getElementById('btn-add-aplicacao').addEventListener('click', addAplicacao);
    aplicacoesRef.on('value', snapshot => {
      const list = document.getElementById('lista-aplicacoes');
      list.innerHTML = '';
      const data = snapshot.val();
      if (data) {
        const grouped = {};
        Object.keys(data).forEach(id => {
          const item = data[id];
          if (!grouped[item.data]) grouped[item.data] = [];
          grouped[item.data].push({id, ...item});
        });
        const sortedDates = Object.keys(grouped).sort();
        sortedDates.forEach(date => {
          const dateHeader = document.createElement('h5');
          dateHeader.textContent = date;
          list.appendChild(dateHeader);
          const ul = document.createElement('ul');
          ul.className = 'list-group mb-3';
          grouped[date].forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = `${item.produto} - ${item.setor} - ${item.tipo} - ${item.dosagem}`;
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-red btn-sm';
            delBtn.innerHTML = '<i class="fas fa-trash"></i>';
            delBtn.onclick = () => aplicacoesRef.child(item.id).remove();
            li.appendChild(delBtn);
            ul.appendChild(li);
          });
          list.appendChild(ul);
        });
      }
    });

    // Tarefas
    const tarefasRef = db.ref('tarefas');
    function addTarefa() {
      const desc = document.getElementById('tarefa-desc').value;
      const prioridade = document.getElementById('tarefa-prioridade').value;
      const tipo = document.getElementById('tarefa-tipo').value;
      if (desc) {
        const newTask = { desc, prioridade, tipo, done: false };
        tarefasRef.push(newTask);
        document.getElementById('tarefa-form').reset();
      }
    }
    document.getElementById('btn-add-tarefa').addEventListener('click', addTarefa);
    tarefasRef.on('value', snapshot => {
      const list = document.getElementById('lista-tarefas');
      list.innerHTML = '';
      const data = snapshot.val();
      if (data) {
        Object.keys(data).forEach(id => {
          const item = data[id];
          const li = document.createElement('div');
          li.className = 'list-group-item';
          li.innerHTML = '<div class="form-check"><input class="form-check-input" type="checkbox" id="task-'+id+'">' +
                         '<label class="form-check-label" for="task-'+id+'">' +
                         item.desc + ' (' + item.prioridade + ')' +
                         '</label></div>';
          list.appendChild(li);
          const checkbox = li.querySelector('input');
          checkbox.checked = item.done;
          checkbox.addEventListener('change', () => {
            tarefasRef.child(id).update({ done: checkbox.checked });
            if (checkbox.checked && item.tipo === 'Aplicação') {
              const newApp = {
                produto: item.desc,
                setor: '',
                tipo: 'Aplicação',
                dosagem: '',
                data: new Date().toISOString().split('T')[0]
              };
              aplicacoesRef.push(newApp);
            }
          });
        });
      }
    });

    // Financeiro
    const finRef = db.ref('financeiro');
    function addFin() {
      const desc = document.getElementById('fin-desc').value;
      const valor = parseFloat(document.getElementById('fin-valor').value);
      const status = document.getElementById('fin-status').value;
      if (desc && valor) {
        finRef.push({ desc, valor, status });
        document.getElementById('fin-form').reset();
      }
    }
    document.getElementById('btn-add-fin').addEventListener('click', addFin);
    function renderFinanceiro() {
      finRef.on('value', snapshot => {
        const data = snapshot.val();
        const avencerList = document.getElementById('fin-avencer');
        const pagosList = document.getElementById('fin-pagos');
        avencerList.innerHTML = '';
        pagosList.innerHTML = '';
        let avencerCount = 0, pagosCount = 0;
        if (data) {
          Object.keys(data).forEach(id => {
            const item = data[id];
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = item.desc + ' - R$' + item.valor.toFixed(2);
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-red btn-sm';
            delBtn.innerHTML = '<i class="fas fa-trash"></i>';
            delBtn.onclick = () => finRef.child(id).remove();
            li.appendChild(delBtn);
            if (item.status === 'avencer') {
              avencerList.appendChild(li);
              avencerCount += item.valor;
            } else {
              pagosList.appendChild(li);
              pagosCount += item.valor;
            }
          });
        }
        updateFinCharts(avencerCount, pagosCount);
      });
    }
    renderFinanceiro();
    function updateFinCharts(avencer, pagos) {
      if (window.barChartFin && window.pieChartFin) {
        window.barChartFin.data.datasets[0].data = [avencer, pagos];
        window.barChartFin.update();
        window.pieChartFin.data.datasets[0].data = [avencer, pagos];
        window.pieChartFin.update();
      }
    }
    const ctxBarFin = document.getElementById('chart-financeiro-bar').getContext('2d');
    window.barChartFin = new Chart(ctxBarFin, {
      type: 'bar',
      data: {
        labels: ['A Vencer', 'Pagos'],
        datasets: [{
          label: 'Valor R$',
          data: [0, 0],
          backgroundColor: ['#ffc107', '#28a745']
        }]
      }
    });
    const ctxPieFin = document.getElementById('chart-financeiro-pie').getContext('2d');
    window.pieChartFin = new Chart(ctxPieFin, {
      type: 'pie',
      data: {
        labels: ['A Vencer', 'Pagos'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['#ffc107', '#28a745']
        }]
      }
    });

    // Colheita
    const colheitaRef = db.ref('colheita');
    function addColheita() {
      const colhedor = document.getElementById('colheita-colhedor').value;
      const data = document.getElementById('colheita-data').value;
      const latas = parseInt(document.getElementById('colheita-latas').value);
      if (colhedor && data && latas) {
        colheitaRef.push({ colhedor, data, latas });
        document.getElementById('colheita-form').reset();
      }
    }
    document.getElementById('btn-add-colheita').addEventListener('click', addColheita);
    colheitaRef.on('value', snapshot => {
      const list = document.getElementById('lista-colheita');
      const totalElem = document.getElementById('total-latas');
      list.innerHTML = '';
      let totalLatas = 0;
      const data = snapshot.val();
      if (data) {
        const grouped = {};
        Object.keys(data).forEach(id => {
          const item = data[id];
          if (!grouped[item.data]) grouped[item.data] = [];
          grouped[item.data].push({id, ...item});
          totalLatas += item.latas;
        });
        totalElem.textContent = totalLatas;
        const sortedDates = Object.keys(grouped).sort();
        sortedDates.forEach(date => {
          const dateHeader = document.createElement('h5');
          dateHeader.textContent = date;
          list.appendChild(dateHeader);
          const ul = document.createElement('ul');
          ul.className = 'list-group mb-3';
          let dailyTotal = 0;
          grouped[date].forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = `${item.colhedor}: ${item.latas} latas`;
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-red btn-sm';
            delBtn.innerHTML = '<i class="fas fa-trash"></i>';
            delBtn.onclick = () => colheitaRef.child(item.id).remove();
            li.appendChild(delBtn);
            ul.appendChild(li);
            dailyTotal += item.latas;
          });
          const totalLi = document.createElement('li');
          totalLi.className = 'list-group-item d-flex justify-content-between align-items-center';
          totalLi.innerHTML = `<strong>Total: ${dailyTotal} latas</strong>`;
          const payBtn = document.createElement('button');
          payBtn.className = 'btn btn-green btn-sm';
          payBtn.textContent = 'Pagar';
          payBtn.onclick = () => {
            finRef.push({ desc: 'Pagamento colheita ' + date, valor: dailyTotal, status: 'pago' });
            grouped[date].forEach(item => colheitaRef.child(item.id).remove());
          };
          totalLi.appendChild(payBtn);
          ul.appendChild(totalLi);
          list.appendChild(ul);
        });
      } else {
        totalElem.textContent = 0;
      }
    });

    // Relatório
    function updateRelatorioCharts() {
      const aplicDataRef = db.ref('aplicacoes');
      const tarefasDataRef = db.ref('tarefas');
      aplicDataRef.once('value', snap => {
        const apps = snap.val();
        const count = apps ? Object.keys(apps).length : 0;
        if (window.chartRelAplic) {
          window.chartRelAplic.data.datasets[0].data = [count];
          window.chartRelAplic.update();
        }
      });
      tarefasDataRef.once('value', snap => {
        const tasks = snap.val();
        let done = 0;
        if (tasks) {
          Object.values(tasks).forEach(t => {
            if (t.done) done++;
          });
        }
        const pend = tasks ? Object.keys(tasks).length - done : 0;
        if (window.chartRelTarefas) {
          window.chartRelTarefas.data.datasets[0].data = [done, pend];
          window.chartRelTarefas.update();
        }
      });
      finRef.once('value', snap => {
        const fin = snap.val();
        let total = 0;
        if (fin) {
          Object.values(fin).forEach(f => { total += f.valor; });
        }
        if (window.chartRelFin) {
          window.chartRelFin.data.datasets[0].data = [total];
          window.chartRelFin.update();
        }
      });
    }
    const ctxRelAplic = document.getElementById('chart-relatorio-aplic').getContext('2d');
    window.chartRelAplic = new Chart(ctxRelAplic, {
      type: 'doughnut',
      data: {
        labels: ['Total Aplicações'],
        datasets: [{ data: [0], backgroundColor: ['#17a2b8'] }]
      }
    });
    const ctxRelTarefas = document.getElementById('chart-relatorio-tarefas').getContext('2d');
    window.chartRelTarefas = new Chart(ctxRelTarefas, {
      type: 'doughnut',
      data: {
        labels: ['Concluídas', 'Pendentes'],
        datasets: [{ data: [0, 0], backgroundColor: ['#28a745','#ffc107'] }]
      }
    });
    const ctxRelFin = document.getElementById('chart-relatorio-fin').getContext('2d');
    window.chartRelFin = new Chart(ctxRelFin, {
      type: 'bar',
      data: {
        labels: ['Total Gasto'],
        datasets: [{ data: [0], backgroundColor: ['#dc3545'] }]
      }
    });
    updateRelatorioCharts();
    aplicacoesRef.on('value', updateRelatorioCharts);
    tarefasRef.on('value', updateRelatorioCharts);
    finRef.on('value', updateRelatorioCharts);

    // PDF Download
    document.getElementById('btn-download-report').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Relatório Manejo Café", 10, 10);
      doc.text("Dados gerados em " + new Date().toLocaleString(), 10, 20);
      doc.save("relatorio.pdf");
    });

    // Config - Theme toggle
    const toggleTheme = document.getElementById('toggle-theme');
    toggleTheme.addEventListener('change', () => {
      document.body.classList.toggle('light-theme');
    });
  </script>
</body>
</html>
